import speech_recognition as sr
import pyttsx3
import sounddevice as sd
import numpy as np
import scipy.io.wavfile as wav
import os
from datetime import date
import meteostat as ms

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–≤–∏–∂–∫–∞ —Ä–µ—á–∏
engine = pyttsx3.init()


# –ü–æ–∏—Å–∫ –∏ –≤—ã–±–æ—Ä –∂–µ–Ω—Å–∫–æ–≥–æ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞
voices = engine.getProperty('voices')
female_voice_found = False


for voice in voices:
    # –ò—â–µ–º –≥–æ–ª–æ—Å —Å —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ –∂–µ–Ω—Å–∫–∏–º —Ç–µ–º–±—Ä–æ–º
    if ('ru' in str(voice.languages) or 'russian' in voice.name.lower()) and 'female' in voice.name.lower():
        engine.setProperty('voice', voice.id)
        female_voice_found = True
        print("‚úÖ –í—ã–±—Ä–∞–Ω –∂–µ–Ω—Å–∫–∏–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –≥–æ–ª–æ—Å")
        break

# –ï—Å–ª–∏ –∂–µ–Ω—Å–∫–∏–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–±—É–µ–º –ª—é–±–æ–π —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π
if not female_voice_found:
    for voice in voices:
        if 'ru' in str(voice.languages) or 'russian' in voice.name.lower():
            engine.setProperty('voice', voice.id)
            print("‚úÖ –í—ã–±—Ä–∞–Ω —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –≥–æ–ª–æ—Å (–∂–µ–Ω—Å–∫–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω)")
            female_voice_found = True
            break

# –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
if not female_voice_found:
    print("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã–π –≥–æ–ª–æ—Å. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≥–æ–ª–æ—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.")


# –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
engine.setProperty('rate', 150)   # –°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏
engine.setProperty('volume', 0.9)  # –ì—Ä–æ–º–∫–æ—Å—Ç—å


# –î–∞–Ω–Ω—ã–µ
cities = ["–ú–æ—Å–∫–≤–∞", "–¢–≤–µ—Ä—å", "–°–∞–Ω–∫—Ç‚Äë–ü–µ—Ç–µ—Ä–±—É—Ä–≥"]
climate = "Antarctica"
commands = ["–∞–Ω–∞–ª–∏–∑", "–æ—Ç–≤–µ—Ç", "–≤—ã—Ö–æ–¥"]
questions = [
    "–ß—Ç–æ —Ç–∞–∫–æ–µ",
    "–ø—Ä–∏—á–∏–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏—è",
    "–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è",
    "–ö–∞–∫ –º—ã –º–æ–∂–µ–º —Ä–µ—à–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É"
]

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ
duration = 4      # —Å–µ–∫
sample_rate = 16000 # –ì—Ü
channels = 1
dtype = "int16"


def record_audio():
    """–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∞—É–¥–∏–æ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ñ–∞–π–ª"""
    print("üéôÔ∏è –°–ª—É—à–∞—é...")
    recording = sd.rec(
        int(duration * sample_rate),
        samplerate=sample_rate,
        channels=channels,
        dtype=dtype
    )
    sd.wait()  # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
    wav.write("output.wav", sample_rate, recording)
    return "output.wav"

def recognize_speech(audio_file):
    """–†–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Ä–µ—á—å –∏–∑ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞"""
    recognizer = sr.Recognizer()
    try:
        with sr.AudioFile(audio_file) as source:
            audio = recognizer.record(source)
        text = recognizer.recognize_google(audio, language="ru-RU")
        print(f"–í—ã —Å–∫–∞–∑–∞–ª–∏: {text}")
        return text.lower()
    except sr.UnknownValueError:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å.")
        return None
    except sr.RequestError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: {e}")
        return None
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ: {e}")
        return None

def get_answer(question):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å"""
    answers = {
        "—á—Ç–æ —Ç–∞–∫–æ–µ": (
            "–ì–ª–æ–±–∞–ª—å–Ω–æ–µ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –ó–µ–º–ª–∏, "
            "–Ω–∞–±–ª—é–¥–∞–µ–º–æ–µ —É–∂–µ –±–æ–ª–µ–µ –≤–µ–∫–∞ (—Å –¥–æ–∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞, –ø—Ä–∏–º–µ—Ä–Ω–æ —Å 1850‚Äì1900 –≥–≥.)."
        ),
        "–ø—Ä–∏—á–∏–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏—è": (
            "–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –≤—ã–±—Ä–æ—Å—ã CO‚ÇÇ –æ—Ç —Å–∂–∏–≥–∞–Ω–∏—è –∏—Å–∫–æ–ø–∞–µ–º–æ–≥–æ —Ç–æ–ø–ª–∏–≤–∞, –≤—ã—Ä—É–±–∫–∞ –ª–µ—Å–æ–≤, –≤—ã–±—Ä–æ—Å—ã –º–µ—Ç–∞–Ω–∞ –æ—Ç —Å–µ–ª—å—Å–∫–æ–≥–æ —Ö–æ–∑—è–π—Å—Ç–≤–∞, "
            "–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ –≥–∞–∑—ã. –í—Å—ë —ç—Ç–æ —É—Å–∏–ª–∏–≤–∞–µ—Ç –ø–∞—Ä–Ω–∏–∫–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç."
        ),
        "–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è": (
            "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –º–æ—Ä—è, —Ç–∞—è–Ω–∏–µ –ª–µ–¥–Ω–∏–∫–æ–≤, —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –ø–æ–≥–æ–¥–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è, —É–≥—Ä–æ–∑–∞ –±–∏–æ—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—é, "
            "—Å–Ω–∏–∂–µ–Ω–∏–µ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏, —Ä–æ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–π, —É—Ö—É–¥—à–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è –ª—é–¥–µ–π."
        ),
        "–∫–∞–∫ –º—ã –º–æ–∂–µ–º —Ä–µ—à–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É": (
            "–†–µ—à–µ–Ω–∏—è: –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —ç–Ω–µ—Ä–≥–∏–∏, –ø–æ–≤—ã—à–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–µ—Å–æ–≤, "
            "—Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—ã–±—Ä–æ—Å–æ–≤ –º–µ—Ç–∞–Ω–∞, —Ä–∞–∑–≤–∏—Ç–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π —É–ª–∞–≤–ª–∏–≤–∞–Ω–∏—è CO‚ÇÇ, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã."
        )
    }
    for key in answers:
        if key in question:
            return answers[key]
    return "‚ùå –Ø –Ω–µ –∑–Ω–∞—é –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å."



def execute_command(text):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not text:
        engine.say("–Ø –Ω–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª–∞ –∫–æ–º–∞–Ω–¥—É. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.")
        engine.runAndWait()
        return True


    if "–≤—ã—Ö–æ–¥" in text:
        engine.say("–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
        engine.runAndWait()
        return False  # –§–ª–∞–≥ –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Ü–∏–∫–ª–∞


    elif "–æ—Ç–≤–µ—Ç" in text or "–≤–æ–ø—Ä–æ—Å" in text:
        output_text = "–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞: " + ", ".join(questions)
        print(output_text)
        engine.say(output_text)
        engine.runAndWait()


        # –ñ–¥—ë–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        audio_file = record_audio()
        user_question = recognize_speech(audio_file)

        if user_question:
            answer = get_answer(user_question)
            print(answer)
            engine.say(answer)
            engine.runAndWait()
        else:
            engine.say("–Ø –Ω–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.")
            engine.runAndWait()

    elif "–∞–Ω–∞–ª–∏–∑" in text:
        engine.say("–ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.")
        engine.runAndWait()

    else:
        engine.say("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞–∑–∞—Ç—å ¬´–æ—Ç–≤–µ—Ç¬ª, ¬´–∞–Ω–∞–ª–∏–∑¬ª –∏–ª–∏ ¬´–≤—ã—Ö–æ–¥¬ª.")
        engine.runAndWait()

    return True  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª

def main():
    # –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    city = input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≥–æ—Ä–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º: ").strip()
    if city:
        cities.append(city)

    engine.say("–ü—Ä–∏–≤–µ—Ç! –Ø –∑–Ω–∞—é –º–Ω–æ–≥–æ –ø—Ä–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–µ.")
    engine.runAndWait()


    print(f"\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: {', '.join(commands)}")
    
    while True:
        audio_file = record_audio()
        command = recognize_speech(audio_file)

        if command:
            if not execute_command(command):
                break  # –í—ã—Ö–æ–¥ –∏–∑ —Ü–∏–∫–ª–∞, –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ ¬´–≤—ã—Ö–æ–¥¬ª

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        if os.path.exists("output.wav"):
            os.remove("output.wav")

if __name__ == "__main__":
    main()
