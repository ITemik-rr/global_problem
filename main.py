# –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫
import speech_recognition as sr
import sounddevice as sd
import scipy.io.wavfile as wav
import os
import requests
import pandas as pd
from datetime import datetime
import matplotlib.pyplot as plt
import time
import random
import subprocess

# =========================
# –ü–æ—á–µ–º—É —Ç–∞–∫:
# - –≠—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç —Å—Ç–∞–±–∏–ª–µ–Ω: –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ TTS ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, Speak() –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è.
# =========================

def _ps_escape_single_quoted(text: str) -> str:
    # –í PowerShell –≤–Ω—É—Ç—Ä–∏ –æ–¥–∏–Ω–∞—Ä–Ω—ã—Ö –∫–∞–≤—ã—á–µ–∫ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ' -> ''
    return text.replace("'", "''").replace("\n", " ").replace("\r", " ")


def speak(text: str):
    """–ü—Ä–æ–∏–∑–Ω–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –∏ –¥–æ–∂–¥–∞—Ç—å—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏—è."""
    text = str(text)
    print(f"üó£Ô∏è {text}")

    safe = _ps_escape_single_quoted(text)
    ps_cmd = (
        "Add-Type -AssemblyName System.Speech; "
        "$speak = New-Object System.Speech.Synthesis.SpeechSynthesizer; "
        "$speak.Volume = 90; "
        "$speak.Rate = 120; "
        f"$speak.Speak('{safe}');"
    )    # -NoProfile, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ–ª–æ –æ—Ç –ø—Ä–æ—Ñ–∏–ª—è PowerShell
    for shell in ("powershell", "pwsh"):
        try:
            subprocess.run(
                [shell, "-NoProfile", "-Command", ps_cmd],
                check=False,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
            )
            break
        except FileNotFoundError:
            continue
    else:
        print("‚ùå PowerShell (powershell/pwsh) –Ω–µ –Ω–∞–π–¥–µ–Ω. TTS –æ—Ç–∫–ª—é—á—ë–Ω.")


# =========================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø–∏—Å–∏
# =========================

duration = 4
sample_rate = 16000
channels = 1
dtype = "int16"

# –ü—Ä–æ—Å–ª—É—à–∫–∞
def record_audio():
    # –í–∞–∂–Ω–æ: –≤—ã–∑—ã–≤–∞–µ–º –∑–∞–ø–∏—Å—å –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ speak(), —á—Ç–æ–±—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–µ —Å–ª—É—à–∞–ª, –ø–æ–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç.
    print("üéôÔ∏è –°–ª—É—à–∞—é...")
    recording = sd.rec(
        int(duration * sample_rate),
        samplerate=sample_rate,
        channels=channels,
        dtype=dtype,
    )
    sd.wait()
    sd.stop()  # –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –∞—É–¥–∏–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    wav.write("output.wav", sample_rate, recording)
    return "output.wav"

# –†–∞—Å–ø–æ–∑–Ω–æ–≤–∞–Ω–∏–µ +  –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏
def recognize_speech(audio_file):
    recognizer = sr.Recognizer()
    try:
        with sr.AudioFile(audio_file) as source:
            audio = recognizer.record(source)
        text = recognizer.recognize_google(audio, language="ru-RU")
        print(f"–í—ã —Å–∫–∞–∑–∞–ª–∏: {text}")
        return text.lower()
    except sr.UnknownValueError:
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å.")
        speak("–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.")
        return None
    except sr.RequestError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: {e}")
        speak("–°–µ—Ä–≤–∏—Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return None
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ: {e}")
        speak("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ.")
        return None

# –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ–≥–æ–¥—ã
city_coordinates = {
    "–ú–æ—Å–∫–≤–∞": (55.7558, 37.6173),
    "–¢–≤–µ—Ä—å": (56.8587, 35.9176),
    "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥": (59.9343, 30.3351),
    "–ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–∞": (-82.8628, 135.0000),
}
# –°–ø–∏—Å–∫–∏ –∏ —Å–ª–æ–≤–∞—Ä–∏ (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞)
cities = list(city_coordinates.keys())
commands = ["–∞–Ω–∞–ª–∏–∑", "–æ—Ç–≤–µ—Ç", "–≤—ã—Ö–æ–¥"]
questions = [
    "—á—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ",
    "–ø—Ä–∏—á–∏–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏—è",
    "–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è",
    "–∫–∞–∫ –º—ã –º–æ–∂–µ–º —Ä–µ—à–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É",
]

# –í–æ–ø—Ä–æ—Å—ã +  –ø—Ä–æ–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏
def get_answer(question):
    answers = {
        "—á—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ": (
            "–ì–ª–æ–±–∞–ª—å–Ω–æ–µ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–µ ‚Äî —ç—Ç–æ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –ó–µ–º–ª–∏, "
            "–Ω–∞–±–ª—é–¥–∞–µ–º–æ–µ —É–∂–µ –±–æ–ª–µ–µ –≤–µ–∫–∞ (—Å –¥–æ–∏–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞, –ø—Ä–∏–º–µ—Ä–Ω–æ —Å 1850‚Äì1900 –≥–≥.)."
        ),
        "–ø—Ä–∏—á–∏–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏—è": (
            "–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã: –≤—ã–±—Ä–æ—Å—ã CO2 –æ—Ç —Å–∂–∏–≥–∞–Ω–∏—è –∏—Å–∫–æ–ø–∞–µ–º–æ–≥–æ —Ç–æ–ø–ª–∏–≤–∞, –≤—ã—Ä—É–±–∫–∞ –ª–µ—Å–æ–≤, –≤—ã–±—Ä–æ—Å—ã –º–µ—Ç–∞–Ω–∞ –æ—Ç —Å–µ–ª—å—Å–∫–æ–≥–æ —Ö–æ–∑—è–π—Å—Ç–≤–∞, "
            "–ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ –≥–∞–∑—ã. –í—Å—ë —ç—Ç–æ —É—Å–∏–ª–∏–≤–∞–µ—Ç –ø–∞—Ä–Ω–∏–∫–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç."
        ),
        "–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è": (
            "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è: –ø–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –º–æ—Ä—è, —Ç–∞—è–Ω–∏–µ –ª–µ–¥–Ω–∏–∫–æ–≤, —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –ø–æ–≥–æ–¥–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è, —É–≥—Ä–æ–∑–∞ –±–∏–æ—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—é, "
            "—Å–Ω–∏–∂–µ–Ω–∏–µ —É—Ä–æ–∂–∞–π–Ω–æ—Å—Ç–∏, —Ä–æ—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–π, —É—Ö—É–¥—à–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è –ª—é–¥–µ–π."
        ),
        "–∫–∞–∫ –º—ã –º–æ–∂–µ–º —Ä–µ—à–∏—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É": (
            "–†–µ—à–µ–Ω–∏—è: –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —ç–Ω–µ—Ä–≥–∏–∏, –ø–æ–≤—ã—à–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–µ—Å–æ–≤, "
            "—Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—ã–±—Ä–æ—Å–æ–≤ –º–µ—Ç–∞–Ω–∞, —Ä–∞–∑–≤–∏—Ç–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π —É–ª–∞–≤–ª–∏–≤–∞–Ω–∏—è CO2, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã."
        ),
    }
    for key in answers:
        if key in question:
            return answers[key]
    return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —É –º–µ–Ω—è –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É. –ó–∞–¥–∞–π—Ç–µ –¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞."

# –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–æ–≥–æ–¥—ã
def get_weather_openmeteo(city):
    if city not in city_coordinates:
        return None
# –¥–æ–±–∞–≤–ª—è–µ—Ç API
    lat, lon = city_coordinates[city]
    url = (
        f"https://api.open-meteo.com/v1/forecast?"
        f"latitude={lat}&longitude={lon}&"
        f"current_weather=true&"
        f"timezone=Europe/Moscow"
    )
# –°–ª–æ–≤–∞—Ä—å –ø–æ–≥–æ–¥–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
    try:
        response = requests.get(url, timeout=15)
        if response.status_code == 200:
            data = response.json()
            current = data["current_weather"]

            weather_conditions = {
                0: "–Ø—Å–Ω–æ",
                1: "–í –æ—Å–Ω–æ–≤–Ω–æ–º —è—Å–Ω–æ",
                2: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å",
                3: "–û–±–ª–∞—á–Ω–æ",
                45: "–¢—É–º–∞–Ω",
                48: "–¢—É–º–∞–Ω —Å –∏–∑–º–æ—Ä–æ–∑—å—é",
                51: "–õ—ë–≥–∫–∏–π –º–æ—Ä–æ—Å—è—â–∏–π –¥–æ–∂–¥—å",
                53: "–£–º–µ—Ä–µ–Ω–Ω—ã–π –º–æ—Ä–æ—Å—è—â–∏–π –¥–æ–∂–¥—å",
                55: "–°–∏–ª—å–Ω—ã–π –º–æ—Ä–æ—Å—è—â–∏–π –¥–æ–∂–¥—å",
                61: "–õ—ë–≥–∫–∏–π –¥–æ–∂–¥—å",
                63: "–£–º–µ—Ä–µ–Ω–Ω—ã–π –¥–æ–∂–¥—å",
                65: "–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å",
                71: "–õ—ë–≥–∫–∏–π —Å–Ω–µ–≥",
                73: "–£–º–µ—Ä–µ–Ω–Ω—ã–π —Å–Ω–µ–≥",
                75: "–°–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥",
                80: "–õ—ë–≥–∫–∏–µ –ª–∏–≤–Ω–∏",
                81: "–£–º–µ—Ä–µ–Ω–Ω—ã–µ –ª–∏–≤–Ω–∏",
                82: "–°–∏–ª—å–Ω—ã–µ –ª–∏–≤–Ω–∏",
                95: "–ì—Ä–æ–∑–∞ —Å–ª–∞–±–∞—è –∏–ª–∏ —É–º–µ—Ä–µ–Ω–Ω–∞—è",
                96: "–ì—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º",
                99: "–°–∏–ª—å–Ω–∞—è –≥—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º",
            }

            condition_text = weather_conditions.get(current["weathercode"], f"–ö–æ–¥ {current['weathercode']}")
# –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫
            return pd.DataFrame(
                [
                    {
                        "date": datetime.now().date(),
                        "tavg": current["temperature"],
                        "wspd": current["windspeed"],
                        "humidity": "N/A",
                        "condition": condition_text,
                    }
                ]
            )
        else:
            print(f"–û—à–∏–±–∫–∞ HTTP: {response.status_code}")
            return None
    except requests.exceptions.Timeout:
        print("‚ùå –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ Open-Meteo")
        return None
    except requests.exceptions.ConnectionError:
        print("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–∏—Å—É Open-Meteo")
        return None
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ Open-Meteo: {e}")
        return None

#  –∫—É—Å–æ–∫ –≥–¥–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∫–æ–º–∞–Ω–¥—ã
# –í—ã—Ö–æ–¥
def execute_command(text):
    if not text:
        speak("–Ø –Ω–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª–∞ –∫–æ–º–∞–Ω–¥—É. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.")
        return True

    if "–≤—ã—Ö–æ–¥" in text:
        farewell_messages = [
            "–ë—ã–ª–æ –æ—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ —Å –≤–∞–º–∏ –ø–æ–æ–±—â–∞—Ç—å—Å—è! –î–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á!",
            "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—â–µ–Ω–∏–µ! –ë—É–¥—É —Ä–∞–¥–∞ –ø–æ–º–æ—á—å —Å–Ω–æ–≤–∞. –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!",
            "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –ù–∞–¥–µ—é—Å—å, –≤—ã —É–∑–Ω–∞–ª–∏ —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ. –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!",
        ]
        speak(random.choice(farewell_messages))
        return False
# –û—Ç–≤–µ—Ç. –ü—Ä–æ—Å–ª—É—à–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
    elif "–æ—Ç–≤–µ—Ç" in text or "–≤–æ–ø—Ä–æ—Å" in text:
        speak("–û—Ç–ª–∏—á–Ω–æ! –ó–∞–¥–∞–π—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–æ–ø—Ä–æ—Å–æ–≤: " + ", ".join(questions))

        for attempt in range(2):
            audio_file = record_audio()
            user_question = recognize_speech(audio_file)

            if user_question:
                answer = get_answer(user_question)
                speak(answer)
                break
            else:
                if attempt == 0:
                    speak("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–æ–ø—Ä–æ—Å. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.")
                else:
                    speak(
                        "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –≤–æ–ø—Ä–æ—Å. –í–µ—Ä–Ω—É—Å—å –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é. "
                        "–°–∫–∞–∂–∏—Ç–µ ¬´–æ—Ç–≤–µ—Ç¬ª, —á—Ç–æ–±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞."
                    )
# –ê–Ω–∞–ª–∏–∑. –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ + –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫
    elif "–∞–Ω–∞–ª–∏–∑" in text:
        speak(
            "–•–æ—Ä–æ—à–æ, –≤—ã–ø–æ–ª–Ω–∏–º –∞–Ω–∞–ª–∏–∑ –ø–æ–≥–æ–¥—ã. –ù–∞–∑–æ–≤–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏–∑ —Å–ø–∏—Å–∫–∞: "
            "–ú–æ—Å–∫–≤–∞, –¢–≤–µ—Ä—å, –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ –∏–ª–∏ –ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–∞."
        )

        chosen_city = None
        for attempt in range(3):
            audio_file = record_audio()
            city_input = recognize_speech(audio_file)

            if city_input:
                for city in cities:
                    if city.lower() in city_input.lower():
                        chosen_city = city
                        break

                if chosen_city:
                    break
                else:
                    if attempt < 2:
                        speak(
                            f"–ì–æ—Ä–æ–¥ '{city_input}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ. "
                            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ—Ä–æ–¥–∞: –ú–æ—Å–∫–≤–∞, –¢–≤–µ—Ä—å, –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥–∞. "
                            f"–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."
                        )
            else:
                if attempt < 2:
                    speak("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ.")

        if not chosen_city:
            speak(
                "–ü–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥. "
                "–í–µ—Ä–Ω—É—Å—å –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é. –°–∫–∞–∂–∏—Ç–µ ¬´–∞–Ω–∞–ª–∏–∑¬ª, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å."
            )
            return True
# –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã + –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫
        print(f"üåç –ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ –¥–ª—è {chosen_city}...")
        df = get_weather_openmeteo(chosen_city)

        if df is None or df.empty:
            speak(
                f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –¥–ª—è {chosen_city}. "
                f"–í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º –∏–ª–∏ —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. "
                f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥."
            )
        else:
            current_data = df.iloc[0]
            temp = float(current_data["tavg"])
            wind = float(current_data["wspd"])
            condition = str(current_data["condition"])
# –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π
            temp_comment = (
                "–æ—á–µ–Ω—å –∂–∞—Ä–∫–æ" if temp > 30 else
                "–∂–∞—Ä–∫–æ" if temp > 25 else
                "—Ç–µ–ø–ª–æ" if temp > 15 else
                "–ø—Ä–æ—Ö–ª–∞–¥–Ω–æ" if temp > 5 else
                "—Ö–æ–ª–æ–¥–Ω–æ" if temp > -5 else
                "–æ—á–µ–Ω—å —Ö–æ–ª–æ–¥–Ω–æ"
            )

            wind_comment = (
                "—à—Ç–∏–ª—å" if wind < 1 else
                "–ª—ë–≥–∫–∏–π –≤–µ—Ç–µ—Ä" if wind < 4 else
                "—É–º–µ—Ä–µ–Ω–Ω—ã–π –≤–µ—Ç–µ—Ä" if wind < 8 else
                "—Å–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä"
            )
# –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            speech_weather = (
                f"–í {chosen_city} —Å–µ–π—á–∞—Å {temp} –≥—Ä–∞–¥—É—Å–æ–≤ ‚Äî —ç—Ç–æ {temp_comment}. "
                f"{wind_comment}, —Å–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ {wind} –º–µ—Ç—Ä–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É. "
                f"–ù–∞ —É–ª–∏—Ü–µ {condition.lower()}. –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!"
            )
            speak(speech_weather)
# –ì—Ä–∞—Ñ–∏–∫–∏
            plt.figure(figsize=(10, 6))
            bars = plt.bar(["–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)", "–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ (–º/—Å)"], [temp, wind])
            plt.title(f"–ü–æ–≥–æ–¥–∞ –≤ {chosen_city}", fontsize=14, fontweight="bold")
            plt.ylabel("–ó–Ω–∞—á–µ–Ω–∏—è", fontsize=12)

            for bar, value in zip(bars, [temp, wind]):
                plt.text(
                    bar.get_x() + bar.get_width() / 2,
                    bar.get_height() + 0.1,
                    f"{value}",
                    ha="center",
                    va="bottom",
                    fontsize=11,
                    fontweight="bold",
                )

            plt.grid(axis="y", alpha=0.3)
            plt.tight_layout()
            plt.show()
 # –û—à–∏–±–∫–∞ –Ω–µ—Ä–∞–∑–±–æ—Ä—á–∏–≤–æ—Å—Ç–∏
    else:
        speak(
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –ø–æ–Ω—è–ª–∞ –∫–æ–º–∞–Ω–¥—É. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: ¬´–æ—Ç–≤–µ—Ç¬ª ‚Äî —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –æ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–∏, "
            "¬´–∞–Ω–∞–ª–∏–∑¬ª ‚Äî —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É –≤ –≥–æ—Ä–æ–¥–µ, –∏ ¬´–≤—ã—Ö–æ–¥¬ª ‚Äî —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É."
        )

    return True

# –û—Å–Ω–æ–≤–Ω–æ–π –∫—É—Å–æ–∫, –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ
def main():
    speak("–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏—è –∏ –ø–æ–≥–æ–¥—ã.")

    print("\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:", ", ".join(commands))
    speak(
        "–ó–∞–ø–æ–º–Ω–∏—Ç–µ –º–æ–∏ –∫–æ–º–∞–Ω–¥—ã: —Å–∫–∞–∂–∏—Ç–µ ¬´–æ—Ç–≤–µ—Ç¬ª, —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ø–æ—Ç–µ–ø–ª–µ–Ω–∏–µ. "
        "–°–∫–∞–∂–∏—Ç–µ ¬´–∞–Ω–∞–ª–∏–∑¬ª, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É –≤ –æ–¥–Ω–æ–º –∏–∑ –≥–æ—Ä–æ–¥–æ–≤. "
        "–ò —Å–∫–∞–∂–∏—Ç–µ ¬´–≤—ã—Ö–æ–¥¬ª, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å–æ –º–Ω–æ–π."
    )
# –æ—à–∏–±–∫–∏
    while True:
        audio_file = record_audio()
        command = recognize_speech(audio_file)

        if command:
            try:
                if not execute_command(command):
                    break
            except Exception as e:
                speak(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}. –í–µ—Ä–Ω—É—Å—å –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.")
        else:
            speak("–Ø –Ω–µ —Ä–∞—Å—Å–ª—ã—à–∞–ª–∞ –∫–æ–º–∞–Ω–¥—É. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.")

        try:
            if os.path.exists("output.wav"):
                os.remove("output.wav")
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: {e}")

        time.sleep(0.5)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
if __name__ == "__main__":
    try:
        print("üöÄ –ó–∞–ø—É—Å–∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞...")
        main()
    except KeyboardInterrupt:
        print("\nüëã –†–∞–±–æ—Ç–∞ –ø–æ–º–æ—â–Ω–∏–∫–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")
        speak("–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –ë—É–¥—É —Ä–∞–¥–∞ –ø–æ–º–æ—á—å –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑.")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}")
        # –Ω–∞ —Ñ–∞—Ç–∞–ª–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—á–∞—Ç–∞–µ–º, –±–µ–∑ –ø–æ–ø—ã—Ç–æ–∫ TTS
        print("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–º–æ—â–Ω–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è.")
